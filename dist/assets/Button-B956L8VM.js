import{c as A,z as u,q}from"./index-8wLK5tP2.js";import{A as E}from"./apiUsageService-40l3Zyjx.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const k=A("Grid3x3",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}],["path",{d:"M9 3v18",key:"fh3hqa"}],["path",{d:"M15 3v18",key:"14nvp0"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=A("List",[["line",{x1:"8",x2:"21",y1:"6",y2:"6",key:"7ey8pc"}],["line",{x1:"8",x2:"21",y1:"12",y2:"12",key:"rjfblc"}],["line",{x1:"8",x2:"21",y1:"18",y2:"18",key:"c3b1m8"}],["line",{x1:"3",x2:"3.01",y1:"6",y2:"6",key:"1g7gq3"}],["line",{x1:"3",x2:"3.01",y1:"12",y2:"12",key:"1pjlvk"}],["line",{x1:"3",x2:"3.01",y1:"18",y2:"18",key:"28t2mc"}]]);class b{constructor(){this.defaultParams={page:1,geo:"US"},this.requestQueue=[],this.isProcessingQueue=!1,this.maxConcurrentRequests=1,this.requestDelay=2500,this.maxRetries=3,this.baseDelay=1e3}sleep(e){return new Promise(r=>setTimeout(r,e))}async retryRequest(e,r=0){var s,t;try{return await e()}catch(o){if((((s=o.response)==null?void 0:s.status)===429||((t=o.response)==null?void 0:t.status)>=500||o.code==="ECONNRESET"||o.code==="ETIMEDOUT")&&r<this.maxRetries){const a=this.baseDelay*Math.pow(2,r);return console.log(`Retrying request in ${a}ms (attempt ${r+1}/${this.maxRetries})`),await this.sleep(a),this.retryRequest(e,r+1)}throw o}}async processRequestQueue(){if(!this.isProcessingQueue){for(this.isProcessingQueue=!0;this.requestQueue.length>0;){const e=this.requestQueue.splice(0,this.maxConcurrentRequests);await Promise.allSettled(e.map(r=>r())),this.requestQueue.length>0&&await this.sleep(this.requestDelay)}this.isProcessingQueue=!1}}queueRequest(e){return new Promise((r,s)=>{this.requestQueue.push(async()=>{try{const t=await e();r(t)}catch(t){s(t)}}),this.processRequestQueue()})}async testConnection(){try{const e=await this.searchProducts({query:"test",page:1});return Array.isArray(e)||e.length>=0}catch(e){return console.error("Amazon RapidAPI connection test failed:",e),!1}}async searchProducts(e){try{const r={...this.defaultParams,...e};return await E.checkApiUsageLimit("amazon")?await this.queueRequest(async()=>this.retryRequest(async()=>{console.log("Searching Amazon via Edge Function:",r.query);const{data:{session:t}}=await u.auth.getSession();if(!t)throw new Error("User not authenticated");await E.incrementApiUsage("amazon");const o=await fetch(`https://lblimaujsnwvcmhljuux.supabase.co/functions/v1/amazon-search?query=${encodeURIComponent(r.query)}&page=${r.page}&geo=${r.geo}`,{headers:{Authorization:`Bearer ${t.access_token}`,"Content-Type":"application/json"},timeout:3e4});if(!o.ok){const a=await o.json();throw new Error(a.error||`Amazon search failed with status ${o.status}`)}const n=await o.json();return console.log("Edge Function response received for:",r.query),this.processResults(n)})):(console.warn("Amazon API usage limit exceeded. Skipping search."),[])}catch(r){return console.error("Amazon search API error:",{message:r.message,query:e.query}),[]}}async searchMultipleQueries(e){if(!e.length)return[];try{console.log(`Searching ${e.length} queries with rate limiting:`,e);const r=e.map(c=>this.searchProducts({query:c}).catch(i=>(console.warn(`Search failed for query "${c}":`,i.message),[]))),s=await Promise.all(r),t=[];let o=0;s.forEach((c,i)=>{Array.isArray(c)&&c.length>0&&(t.push(...c),o++)}),console.log(`Search completed: ${o}/${e.length} successful, ${t.length} total products`);const a=this.removeDuplicates(t).slice(0,500);return console.log(`Returning ${a.length} unique products`),a}catch(r){return console.error("Multiple search failed:",r),[]}}processResults(e){if(!e)return console.warn("No data received from API"),[];let r=[];if(Array.isArray(e))r=e;else if(e.products&&Array.isArray(e.products))r=e.products;else if(e.results&&Array.isArray(e.results))r=e.results;else if(e.data&&Array.isArray(e.data))r=e.data;else if(e.items&&Array.isArray(e.items))r=e.items;else return console.warn("Could not find products array in response:",Object.keys(e)),[];return Array.isArray(r)?(console.log(`Processing ${r.length} raw products`),r.map(s=>this.mapProductData(s)).filter(s=>s!==null)):(console.warn("Products is not an array:",typeof r),[])}mapProductData(e){try{const r=e.product_title||e.title||e.name||e.productTitle||"",s=e.asin||e.id||e.product_id||e.productId||e.product_asin||e.productAsin||`MISSING_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;if(!r||!s||s==="")return console.warn("Skipping product with missing title or ASIN:",{title:r,asin:s,item:e}),null;const t=this.extractPrice(e.product_price||e.price||e.current_price||e.currentPrice||e.price_current||e.priceCurrent||e.list_price||e.listPrice||0),o=this.extractRating(e.product_star_rating||e.rating||e.stars||e.star_rating||e.starRating||e.average_rating||e.averageRating||0),n=this.extractReviewCount(e.product_num_ratings||e.reviews_count||e.reviewsCount||e.review_count||e.reviewCount||e.total_reviews||e.totalReviews||0),a=e.product_photo||e.image||e.image_url||e.imageUrl||e.thumbnail||e.img||e.picture||"",c=e.product_url||e.url||e.link||e.productUrl||e.amazon_url||e.amazonUrl||`https://amazon.com/dp/${s}`;return{title:r.trim(),price:t,currency:e.currency||"USD",rating:o,reviewsCount:n,image:a,url:c,asin:s.toString().trim()}}catch(r){return console.warn("Error mapping product data:",r,e),null}}extractPrice(e){if(typeof e=="number")return Math.max(0,e);if(typeof e=="string"){let r=e.replace(/[^\d.,]/g,"");r.includes(",")&&!r.includes(".")?r=r.replace(",","."):r.includes(",")&&r.includes(".")&&(r=r.replace(/,/g,""));const s=parseFloat(r);return isNaN(s)?0:Math.max(0,s)}return 0}extractRating(e){if(typeof e=="number")return Math.min(5,Math.max(0,e));if(typeof e=="string"){const r=parseFloat(e.replace(/[^0-9.]/g,""));return isNaN(r)?0:Math.min(5,Math.max(0,r))}return 0}extractReviewCount(e){if(typeof e=="number")return Math.max(0,Math.floor(e));if(typeof e=="string"){let r=e.replace(/[^0-9.K,]/gi,"");if(r.includes("K")){const t=parseFloat(r.replace("K",""));return isNaN(t)?0:Math.floor(t*1e3)}const s=parseInt(r.replace(/,/g,""));return isNaN(s)?0:Math.max(0,s)}return 0}removeDuplicates(e){const r=new Set;return e.filter(s=>r.has(s.asin)?!1:(r.add(s.asin),!0))}async getSearchSuggestions(e){try{return[e]}catch(r){return console.error("Failed to get search suggestions:",r),[e]}}}const f=new b;class v{constructor(){this.defaultParams={page:1},this.requestQueue=[],this.isProcessingQueue=!1,this.maxConcurrentRequests=1,this.requestDelay=2500,this.maxRetries=3,this.baseDelay=1e3,this.isApiAvailable=!0,this.lastApiCheck=0,this.apiCheckInterval=3e5}sleep(e){return new Promise(r=>setTimeout(r,e))}handleApiError(e,r){var n,a,c,i,h,d;const s=(n=e.response)==null?void 0:n.status,t=(a=e.response)==null?void 0:a.statusText,o=(c=e.response)==null?void 0:c.data;switch(console.error("‚ùå Etsy API Error Details:",{status:s,statusText:t,responseData:o,query:r,url:(i=e.config)==null?void 0:i.url,headers:(h=e.config)==null?void 0:h.headers}),s){case 401:return this.isApiAvailable=!1,new Error("Etsy API authentication failed. Please check your RapidAPI key.");case 403:return this.isApiAvailable=!1,(d=o==null?void 0:o.message)!=null&&d.includes("not subscribed")?new Error("Etsy API subscription required. Please subscribe to the Etsy API on RapidAPI dashboard to enable Etsy product searches."):new Error("Etsy API access forbidden. Your RapidAPI key may be invalid, expired, or lack permissions for the Etsy API. Please verify your subscription and key in the RapidAPI dashboard.");case 429:return new Error("Etsy API rate limit exceeded. Please wait before making more requests.");case 500:case 502:case 503:case 504:return new Error("Etsy API server error. Please try again later.");default:return new Error(`Etsy API request failed with status ${s}: ${t||"Unknown error"}`)}}shouldSkipApiCall(){const e=Date.now();return!this.isApiAvailable&&e-this.lastApiCheck<this.apiCheckInterval?(console.log("‚è≠Ô∏è Skipping Etsy API call due to previous authentication/subscription issues"),!0):(!this.isApiAvailable&&e-this.lastApiCheck>=this.apiCheckInterval&&(console.log("üîÑ Resetting Etsy API availability check"),this.isApiAvailable=!0,this.lastApiCheck=e),!1)}async retryRequest(e,r=0){var s,t,o,n;try{return await e()}catch(a){const c=((s=a.response)==null?void 0:s.status)===401||((t=a.response)==null?void 0:t.status)===403;c&&(this.lastApiCheck=Date.now());const i=((o=a.response)==null?void 0:o.status)===429||((n=a.response)==null?void 0:n.status)>=500||a.code==="ECONNRESET"||a.code==="ETIMEDOUT";if(!c&&i&&r<this.maxRetries){const h=this.baseDelay*Math.pow(2,r);return console.log(`üîÑ Retrying Etsy request in ${h}ms (attempt ${r+1}/${this.maxRetries})`),await this.sleep(h),this.retryRequest(e,r+1)}throw this.handleApiError(a)}}async processRequestQueue(){if(!this.isProcessingQueue){for(this.isProcessingQueue=!0;this.requestQueue.length>0;){const e=this.requestQueue.splice(0,this.maxConcurrentRequests);await Promise.allSettled(e.map(r=>r())),this.requestQueue.length>0&&(console.log(`‚è≥ Etsy: Waiting ${this.requestDelay}ms before next batch...`),await this.sleep(this.requestDelay))}this.isProcessingQueue=!1}}queueRequest(e){return new Promise((r,s)=>{this.requestQueue.push(async()=>{try{const t=await e();r(t)}catch(t){s(t)}}),this.processRequestQueue()})}async testConnection(){try{if(this.shouldSkipApiCall())return!1;console.log("üß™ Testing Etsy API connection...");const e=await this.searchProducts({query:"test"}),r=Array.isArray(e)&&e.length>=0;return console.log(`üß™ Etsy API test result: ${r?"‚úÖ Working":"‚ùå Failed"}`),r}catch(e){return console.error("‚ùå Etsy API connection test failed:",e),!1}}async searchProducts(e){if(this.shouldSkipApiCall())return console.log("‚è≠Ô∏è Skipping Etsy search due to API unavailability"),[];if(!await E.checkApiUsageLimit("etsy"))return console.warn("Etsy API usage limit exceeded. Skipping search."),[];const s={...this.defaultParams,...e};return this.queueRequest(async()=>this.retryRequest(async()=>{console.log("üîç Searching Etsy via Edge Function:",s.query);const{data:{session:t}}=await u.auth.getSession();if(!t)throw new Error("User not authenticated");await E.incrementApiUsage("etsy");const o=await fetch(`https://lblimaujsnwvcmhljuux.supabase.co/functions/v1/etsy-search?query=${encodeURIComponent(s.query)}&page=${s.page}`,{headers:{Authorization:`Bearer ${t.access_token}`,"Content-Type":"application/json"},timeout:3e4});if(!o.ok){const a=await o.json();throw new Error(a.error||`Etsy search failed with status ${o.status}`)}const n=await o.json();return console.log("üì¶ Etsy API response received for:",s.query),this.processResults(n)})).catch(t=>(console.error("‚ùå Etsy search failed for query:",s.query,t.message),[]))}async searchMultipleQueries(e){if(!e.length)return console.log("‚ö†Ô∏è No Etsy queries provided"),[];if(this.shouldSkipApiCall())return console.log("‚è≠Ô∏è Skipping all Etsy searches due to API unavailability (subscription/auth issues)"),[];console.log(`üöÄ Starting Etsy search with ${e.length} queries:`,e);try{const r=e.map(c=>this.searchProducts({query:c}).catch(i=>(console.warn(`‚ö†Ô∏è Etsy search failed for query "${c}":`,i.message),[]))),s=await Promise.all(r),t=[];let o=0;s.forEach((c,i)=>{Array.isArray(c)&&c.length>0?(t.push(...c),o++,console.log(`‚úÖ Etsy query "${e[i]}" returned ${c.length} products`)):console.log(`‚ùå Etsy query "${e[i]}" returned no products`)}),console.log(`üéØ Etsy search completed: ${o}/${e.length} successful, ${t.length} total products`);const a=this.removeDuplicates(t).slice(0,500);return console.log(`üìã Returning ${a.length} unique Etsy products`),a}catch(r){return console.error("üí• Etsy multiple search failed:",r),r instanceof Error&&(r.message.includes("authentication")||r.message.includes("forbidden")||r.message.includes("403")||r.message.includes("subscription"))?(console.error("üîë Etsy API Key Issue: Please check your RapidAPI subscription and key configuration"),[]):(console.error("üîÑ Returning empty results to allow other marketplaces to continue"),[])}}processResults(e){if(!e)return console.warn("‚ö†Ô∏è No data received from Etsy API"),[];console.log("üîç Processing Etsy API response structure:",Object.keys(e));let r=[];if(e.response){if(console.log("üì¶ Found response key in data"),Array.isArray(e.response))r=e.response,console.log("üì¶ Response is an array with length:",r.length);else if(typeof e.response=="object"){const t=Object.keys(e.response).filter(o=>!isNaN(Number(o)));t.length>0&&(console.log("üì¶ Response is an object with numeric keys:",t.length),r=t.map(o=>e.response[o]))}}else if(Array.isArray(e))r=e,console.log("üì¶ Found results as root array");else if(e.results&&Array.isArray(e.results))r=e.results,console.log("üì¶ Found results in data.results");else if(e.data&&Array.isArray(e.data))r=e.data,console.log("üì¶ Found results in data.data");else if(e.products&&Array.isArray(e.products))r=e.products,console.log("üì¶ Found results in data.products");else{const t=Object.keys(e).filter(o=>!isNaN(Number(o)));if(t.length>0)console.log("üì¶ Found results as numeric properties of the root object"),r=t.map(o=>e[o]);else return console.warn("‚ö†Ô∏è Could not find results array in Etsy response. Available keys:",Object.keys(e)),[]}if(!Array.isArray(r))return console.warn("‚ö†Ô∏è Etsy results is not an array:",typeof r),[];console.log(`üìä Processing ${r.length} raw Etsy products`),r.length>0&&console.log("üì¶ First product structure:",JSON.stringify(r[0],null,2));const s=r.map((t,o)=>{const n=this.mapProductData(t);return n||console.log(`‚ùå Skipped Etsy product ${o+1}`),n}).filter(t=>t!==null);return console.log(`‚úÖ Successfully processed ${s.length} Etsy products`),s}mapProductData(e){var r,s,t;try{const o=e.title||"",n=e.listingId||e.listing_id||e.id||"";if(!o||!n)return console.log(`‚ùå Missing essential data - title: "${o}", listingId: "${n}"`),null;let a=0;e.price&&typeof e.price=="object"&&e.price.salePrice?a=this.extractPrice(e.price.salePrice):e.salePrice?a=this.extractPrice(e.salePrice):e.originalPrice||(r=e.price)!=null&&r.originalPrice?a=this.extractPrice(e.originalPrice||((s=e.price)==null?void 0:s.originalPrice)):e.price&&typeof e.price=="number"?a=e.price:e.price&&typeof e.price=="string"&&(a=this.extractPrice(e.price)),(a<=0||a>1e5)&&(console.warn(`‚ö†Ô∏è Suspicious price value: ${a}, using default`),a=99.99);let c="";if(e.imageUrl)c=e.imageUrl;else if(e.image)c=e.image;else if(e.images&&e.images.length>0){const g=e.images[0];c=g.url_570xN||g.url||""}else e.image_url?c=e.image_url:e.thumbnail_url&&(c=e.thumbnail_url);const i=e.productUrl||e.url||`https://www.etsy.com/listing/${n}`,h=this.extractRating(e.rating||0),d=e.reviewsCount||e.reviews_count||0,m=e.currency||((t=e.price)==null?void 0:t.currency)||"USD";return{title:o.trim(),price:a,currency:m,rating:h,reviewsCount:d,image:c,url:i,listingId:n.toString(),source:"etsy"}}catch(o){return console.error("‚ùå Error mapping Etsy product data:",o),null}}extractPrice(e){if(typeof e=="number")return Math.max(0,e);if(typeof e=="string"){const r=e.replace(/[^\d.]/g,""),s=parseFloat(r);return isNaN(s)?0:Math.max(0,s)}return 0}extractRating(e){if(typeof e=="number")return Math.min(5,Math.max(0,e));if(typeof e=="string"){const r=parseFloat(e.replace(/[^0-9.]/g,""));return isNaN(r)?0:Math.min(5,Math.max(0,r))}return 0}extractReviewCount(e){if(typeof e=="number")return Math.max(0,Math.floor(e));if(typeof e=="string"){const r=parseInt(e.replace(/[^0-9]/g,""));return isNaN(r)?0:Math.max(0,r)}return 0}removeDuplicates(e){const r=new Set;return e.filter(s=>r.has(s.listingId)?!1:(r.add(s.listingId),!0))}}const P=new v;class S{async searchSingleMarketplace(e,r,s){console.log(`Searching ${e} for query: "${r}"`);try{let t=[];return e==="amazon"?t=(await f.searchMultipleQueries([r])).map(n=>this.convertAmazonProduct(n,s)):t=(await P.searchMultipleQueries([r])).map(n=>this.convertEtsyProduct(n,s)),console.log(`Found ${t.length} products from ${e} for query "${r}"`),t}catch(t){return console.error(`Error searching ${e} for query "${r}":`,t),[]}}convertAmazonProduct(e,r){return{title:e.title,price:e.price,currency:e.currency,rating:e.rating,reviewsCount:e.reviewsCount,image:e.image,url:e.url,id:e.asin,asin:e.asin,source:"amazon",originalData:e,elementId:r}}convertEtsyProduct(e,r){return{title:e.title,price:e.price,currency:e.currency,rating:e.rating,reviewsCount:e.reviewsCount,image:e.image,url:e.url,id:e.listingId,asin:e.listingId,source:"etsy",originalData:e,elementId:r}}shuffleArray(e){const r=[...e];for(let s=r.length-1;s>0;s--){const t=Math.floor(Math.random()*(s+1));[r[s],r[t]]=[r[t],r[s]]}return r}balanceResults(e,r){if(e.length<=r)return e;const s=e.filter(h=>h.source==="amazon"),t=e.filter(h=>h.source==="etsy"),o=Math.ceil(r*.6),n=r-o,a=s.slice(0,o),c=t.slice(0,n),i=a.length+c.length;if(i<r){const h=r-i;a.length<o?a.push(...t.slice(c.length,c.length+h)):c.push(...s.slice(a.length,a.length+h))}return this.shuffleArray([...a,...c])}async searchBothPlatforms(e){try{console.log("Searching both Amazon and Etsy with platform-specific queries");const[r,s]=await Promise.all([f.searchMultipleQueries(e.amazon).then(o=>o.map(n=>this.convertAmazonProduct(n))).catch(o=>(console.error("Amazon search failed:",o),[])),P.searchMultipleQueries(e.etsy).then(o=>o.map(n=>this.convertEtsyProduct(n))).catch(o=>(console.error("Etsy search failed:",o),[]))]);console.log(`Found ${r.length} Amazon products and ${s.length} Etsy products`);const t=[...r,...s];return this.balanceResults(t,1e3)}catch(r){return console.error("Error searching both platforms:",r),[]}}async testConnections(){const[e,r]=await Promise.allSettled([f.testConnection(),P.testConnection()]);return{amazon:e.status==="fulfilled"?e.value:!1,etsy:r.status==="fulfilled"?r.value:!1}}async searchAmazonOnly(e){try{return(await f.searchMultipleQueries(e)).map(s=>this.convertAmazonProduct(s))}catch(r){return console.error("Error in Amazon-only search:",r),[]}}}const w=new S;class z{static async ensureAuthenticated(){try{const{data:{session:e},error:r}=await u.auth.getSession();if(r)throw console.error("Auth session error:",r),new Error("Authentication error. Please sign in again.");if(!(e!=null&&e.user))throw new Error("User not authenticated. Please sign in.");return e}catch(e){throw console.error("Error checking authentication:",e),new Error("Authentication check failed. Please sign in again.")}}static async createProject(e){try{const r=await this.ensureAuthenticated(),{data:s,error:t}=await u.from("projects").insert({...e,user_id:r.user.id}).select().single();if(t)throw console.error("Error creating project:",t),new Error(`Failed to create project: ${t.message}`);if(!s)throw new Error("No data returned from project creation");return s}catch(r){throw console.error("Error in createProject:",r),new Error(r.message||"Failed to create project")}}static async createProjectWithSearch(e,r,s){try{console.log("Starting project creation with individual element searches...");let t;const o=await this.ensureAuthenticated(),{data:n,error:a}=await u.from("projects").select("*").eq("user_id",o.user.id).eq("name",e.name).eq("status","analyzing").maybeSingle();if(a)throw console.error("Error checking for existing project:",a),new Error(`Failed to check for existing project: ${a.message}`);n?(t=n,console.log("Using existing project:",t.id)):(t=await this.createProject({...e,status:"analyzing"}),console.log("Project created:",t.id));let c=null;try{console.log("Attempting to upload image..."),c=await this.uploadProjectImage(r,t.id),console.log("Image uploaded successfully:",c)}catch(l){console.warn("Image upload failed, continuing without image:",l)}const i=await this.updateProject(t.id,{image_url:c,status:"analyzing"});let h=[];s.length>0&&(console.log("Creating project elements..."),h=await this.createProjectElements(t.id,s),console.log("Elements created:",h.length));let d=[];for(const l of h){if(!l.selected_amazon_query&&!l.selected_etsy_query){console.log(`Element ${l.name} has no selected queries, skipping search`);continue}try{console.log(`Processing element: ${l.name}`);let g=[];if(l.selected_amazon_query){console.log(`Searching Amazon for element ${l.name} with query: ${l.selected_amazon_query}`);const p=await w.searchSingleMarketplace("amazon",l.selected_amazon_query,l.id);g=[...g,...p],console.log(`Found ${p.length} Amazon products for element ${l.name}`)}if(l.selected_etsy_query){console.log(`Searching Etsy for element ${l.name} with query: ${l.selected_etsy_query}`);const p=await w.searchSingleMarketplace("etsy",l.selected_etsy_query,l.id);g=[...g,...p],console.log(`Found ${p.length} Etsy products for element ${l.name}`)}g.length>0&&(await this.storeProductsForElement(t.id,l.id,g),d=[...d,...g])}catch(g){console.error(`Error searching for element ${l.name}:`,g)}}const m=await this.updateProject(t.id,{status:"complete"});return console.log("Project creation completed successfully"),{project:m,products:d}}catch(t){throw console.error("Error creating project with search:",t),new Error(t.message||"Failed to create project. Please try again.")}}static async storeProductsForElement(e,r,s){try{console.log(`Storing ${s.length} products for element ${r}`);const t=s.filter(c=>c.asin&&c.asin.trim()!==""&&c.title&&c.title.trim()!=="");if(t.length===0)return console.warn("No valid products to store (all products missing required ASIN or title)"),[];const o=t.map(c=>({project_id:e,project_element_id:r,asin:c.asin,title:c.title,price:c.price,currency:c.currency,rating:c.rating,reviews_count:c.reviews_count,image:c.image,url:c.url,source:c.source})),{data:n,error:a}=await u.from("project_products").insert(o).select();if(a)throw console.error("Error storing products for element:",a),new Error(`Failed to store products for element: ${a.message}`);return console.log(`Successfully stored ${(n==null?void 0:n.length)||0} products for element ${r}`),n||[]}catch(t){throw console.error("Error in storeProductsForElement:",t),new Error(t.message||"Failed to store products for element")}}static async getProductsForElement(e){try{const{data:r,error:s}=await u.from("project_products").select("*").eq("project_element_id",e).order("created_at",{ascending:!0});if(s)throw console.error("Error fetching products for element:",s),new Error(`Failed to fetch products for element: ${s.message}`);return(r||[]).map(t=>({title:t.title,price:t.price||0,currency:t.currency||"USD",rating:t.rating||0,reviews_count:t.reviews_count||0,image:t.image||"",url:t.url||"",id:t.asin,asin:t.asin,source:t.source,elementId:t.project_element_id||void 0,originalData:{title:t.title,price:t.price||0,currency:t.currency||"USD",rating:t.rating||0,reviewsCount:t.reviews_count||0,image:t.image||"",url:t.url||"",asin:t.asin}}))}catch(r){throw console.error("Error in getProductsForElement:",r),new Error(r.message||"Failed to fetch products for element")}}static async getProjectProducts(e){try{const{data:r,error:s}=await u.from("project_products").select("*").eq("project_id",e).order("created_at",{ascending:!0});if(s)throw console.error("Error fetching project products:",s),new Error(`Failed to fetch project products: ${s.message}`);return(r||[]).map(t=>({title:t.title,price:t.price||0,currency:t.currency||"USD",rating:t.rating||0,reviews_count:t.reviews_count||0,image:t.image||"",url:t.url||"",id:t.asin,asin:t.asin,source:t.source,elementId:t.project_element_id||void 0,originalData:{title:t.title,price:t.price||0,currency:t.currency||"USD",rating:t.rating||0,reviewsCount:t.reviews_count||0,image:t.image||"",url:t.url||"",asin:t.asin}}))}catch(r){throw console.error("Error in getProjectProducts:",r),new Error(r.message||"Failed to fetch project products")}}static async getProjectWithProductsData(e){try{const r=await this.getProject(e);if(!r)return null;const s=await this.getProjectElements(e);console.log(`Found ${s.length} elements for project ${e}`);const t={amazon:[],etsy:[]};let o=[];for(const n of s)try{const a=await this.getProductsForElement(n.id);console.log(`Found ${a.length} products for element ${n.name}`),o=[...o,...a],n.search_queries&&(n.search_queries.amazon&&Array.isArray(n.search_queries.amazon)&&t.amazon.push(...n.search_queries.amazon),n.search_queries.etsy&&Array.isArray(n.search_queries.etsy)&&t.etsy.push(...n.search_queries.etsy))}catch(a){console.warn(`Error getting products for element ${n.name}:`,a)}return console.log(`Total products found for project: ${o.length}`),{project:r,elements:s,products:o,searchQueries:t}}catch(r){throw console.error("Error getting project with products data:",r),new Error(r.message||"Failed to get project data")}}static async getElementsWithProducts(e){try{const{data:r,error:s}=await u.from("project_elements").select("*").eq("project_id",e).order("created_at",{ascending:!0});if(s)throw console.error("Error fetching project elements:",s),new Error(`Failed to fetch project elements: ${s.message}`);if(!r||r.length===0)return[];const t=[];for(const o of r)try{const n=await this.getProductsForElement(o.id);t.push({...o,products:n})}catch(n){console.error(`Error getting products for element ${o.id}:`,n),t.push({...o,products:[]})}return t}catch(r){throw console.error("Error in getElementsWithProducts:",r),new Error(r.message||"Failed to get elements with products")}}static async refreshElementProducts(e){try{const r=await this.getProjectElement(e);if(!r||!r.selected_amazon_query&&!r.selected_etsy_query)return console.log(`Element ${e} not found or has no selected queries`),[];await u.from("project_products").delete().eq("project_element_id",e);let s=[];if(r.selected_amazon_query){console.log(`Searching Amazon for element ${r.name} with query: ${r.selected_amazon_query}`);const t=await w.searchSingleMarketplace("amazon",r.selected_amazon_query,r.id);s=[...s,...t],console.log(`Found ${t.length} Amazon products for element ${r.name}`)}if(r.selected_etsy_query){console.log(`Searching Etsy for element ${r.name} with query: ${r.selected_etsy_query}`);const t=await w.searchSingleMarketplace("etsy",r.selected_etsy_query,r.id);s=[...s,...t],console.log(`Found ${t.length} Etsy products for element ${r.name}`)}return s.length>0&&await this.storeProductsForElement(r.project_id,r.id,s),s}catch(r){throw console.error(`Error refreshing products for element ${e}:`,r),new Error(r.message||"Failed to refresh products for element")}}static async refreshProjectProducts(e){try{const r=await this.getProjectElements(e);console.log(`Refreshing products for ${r.length} elements in project ${e}`);let s=[];for(const t of r){if(!t.selected_amazon_query&&!t.selected_etsy_query){console.log(`Element ${t.name} has no selected queries, skipping refresh`);continue}try{const o=await this.refreshElementProducts(t.id);s=[...s,...o]}catch(o){console.warn(`Error refreshing products for element ${t.name}:`,o)}}return console.log(`Refreshed a total of ${s.length} products for project ${e}`),s}catch(r){throw console.error("Error refreshing project products:",r),new Error(r.message||"Failed to refresh products for project")}}static async getProjects(){try{const e=await this.ensureAuthenticated(),{data:r,error:s}=await u.from("projects").select("*").eq("user_id",e.user.id).order("created_at",{ascending:!1});if(s)throw console.error("Error fetching projects:",s),new Error(`Failed to fetch projects: ${s.message}`);return r||[]}catch(e){throw console.error("Error in getProjects:",e),new Error(e.message||"Failed to fetch projects")}}static async getProject(e){try{const r=await this.ensureAuthenticated(),{data:s,error:t}=await u.from("projects").select("*").eq("id",e).eq("user_id",r.user.id).single();if(t){if(t.code==="PGRST116")return null;throw console.error("Error fetching project:",t),new Error(`Failed to fetch project: ${t.message}`)}return s}catch(r){throw console.error("Error in getProject:",r),r.message.includes("not authenticated")?r:new Error(r.message||"Failed to fetch project")}}static async updateProject(e,r){try{const s=await this.ensureAuthenticated(),{data:t,error:o}=await u.from("projects").update(r).eq("id",e).eq("user_id",s.user.id).select().single();if(o)throw console.error("Error updating project:",o),new Error(`Failed to update project: ${o.message}`);if(!t)throw new Error("No data returned from project update");return t}catch(s){throw console.error("Error in updateProject:",s),new Error(s.message||"Failed to update project")}}static async deleteProject(e){try{const r=await this.ensureAuthenticated();try{const t=await this.getProject(e);if(t!=null&&t.image_url){const o=t.image_url.split("/"),n=o[o.length-1];n&&await u.storage.from("project-images").remove([n])}}catch(t){console.warn("Failed to delete project image from storage:",t)}const{error:s}=await u.from("projects").delete().eq("id",e).eq("user_id",r.user.id);if(s)throw console.error("Error deleting project:",s),new Error(`Failed to delete project: ${s.message}`)}catch(r){throw console.error("Error in deleteProject:",r),new Error(r.message||"Failed to delete project")}}static async createProjectElements(e,r){try{const s=r.map(n=>({...n,project_id:e})),{data:t,error:o}=await u.from("project_elements").insert(s).select();if(o)throw console.error("Error creating project elements:",o),new Error(`Failed to create project elements: ${o.message}`);return t||[]}catch(s){throw console.error("Error in createProjectElements:",s),new Error(s.message||"Failed to create project elements")}}static async getProjectElements(e){try{const{data:r,error:s}=await u.from("project_elements").select("*").eq("project_id",e).order("created_at",{ascending:!0});if(s)throw console.error("Error fetching project elements:",s),new Error(`Failed to fetch project elements: ${s.message}`);return r||[]}catch(r){throw console.error("Error in getProjectElements:",r),new Error(r.message||"Failed to fetch project elements")}}static async getProjectElement(e){try{const{data:r,error:s}=await u.from("project_elements").select("*").eq("id",e).single();if(s){if(s.code==="PGRST116")return null;throw console.error("Error fetching project element:",s),new Error(`Failed to fetch project element: ${s.message}`)}return r}catch(r){throw console.error("Error in getProjectElement:",r),new Error(r.message||"Failed to fetch project element")}}static async updateProjectElement(e,r){try{const{data:s,error:t}=await u.from("project_elements").update(r).eq("id",e).select().single();if(t)throw console.error("Error updating project element:",t),new Error(`Failed to update project element: ${t.message}`);if(!s)throw new Error("No data returned from project element update");return s}catch(s){throw console.error("Error in updateProjectElement:",s),new Error(s.message||"Failed to update project element")}}static async deleteProjectElement(e){try{const{error:r}=await u.from("project_elements").delete().eq("id",e);if(r)throw console.error("Error deleting project element:",r),new Error(`Failed to delete project element: ${r.message}`)}catch(r){throw console.error("Error in deleteProjectElement:",r),new Error(r.message||"Failed to delete project element")}}static async uploadProjectImage(e,r){var s,t,o,n,a,c;try{if(console.log("Starting image upload for project:",r),!e||!e.type.startsWith("image/"))throw new Error("Invalid file type. Please upload an image.");const i=10*1024*1024;if(e.size>i)throw new Error("File too large. Please upload an image smaller than 10MB.");const h=((s=e.name.split(".").pop())==null?void 0:s.toLowerCase())||"jpg",d=Date.now(),m=`${r}-${d}.${h}`;console.log("Uploading file:",m);const{data:l,error:g}=await u.storage.from("project-images").upload(m,e,{cacheControl:"3600",upsert:!1});if(g){if(console.error("Storage upload error:",g),(t=g.message)!=null&&t.includes("Bucket not found"))throw new Error("Storage bucket not configured. Please contact support.");if((o=g.message)!=null&&o.includes("Duplicate")){const _=`${r}-${d}-${Math.random().toString(36).substr(2,9)}.${h}`,{data:$,error:j}=await u.storage.from("project-images").upload(_,e,{cacheControl:"3600",upsert:!1});if(j)throw new Error(`Upload failed: ${j.message}`);l.path=$.path}else throw new Error(`Upload failed: ${g.message}`)}if(!(l!=null&&l.path))throw new Error("Upload succeeded but no file path returned");console.log("File uploaded successfully:",l.path);const{data:p}=u.storage.from("project-images").getPublicUrl(l.path);if(!(p!=null&&p.publicUrl))throw new Error("Failed to generate public URL for uploaded image");return console.log("Public URL generated:",p.publicUrl),p.publicUrl}catch(i){throw console.error("Image upload failed:",i),(n=i.message)!=null&&n.includes("Storage bucket not configured")||(a=i.message)!=null&&a.includes("Invalid file type")||(c=i.message)!=null&&c.includes("File too large")?i:new Error(i.message||"Failed to upload image. Please try again.")}}static async getProjectWithElements(e){try{const r=await this.getProject(e);if(!r)return null;const s=await this.getProjectElements(e);return{project:r,elements:s}}catch(r){throw console.error("Error in getProjectWithElements:",r),new Error(r.message||"Failed to get project with elements")}}static async updateSelectedQueries(e){try{const r=e.map(({elementId:s,selectedAmazonQuery:t,selectedEtsyQuery:o})=>this.updateProjectElement(s,{selected_amazon_query:t,selected_etsy_query:o}));await Promise.all(r)}catch(r){throw console.error("Error in updateSelectedQueries:",r),new Error(r.message||"Failed to update selected queries")}}}const I=({children:y,variant:e="primary",size:r="md",className:s="",onClick:t})=>{const o="font-sans inline-flex items-center justify-center transition-all duration-300 ease-in-out",n={primary:"bg-charcoal text-ivory hover:bg-gray-800 border border-transparent",secondary:"bg-gold text-charcoal hover:bg-gold-light border border-transparent",outline:"bg-transparent text-charcoal hover:bg-gray-100 border border-charcoal"},a={sm:"text-xs px-4 py-2",md:"text-sm px-6 py-3",lg:"text-base px-8 py-4"},c=`${o} ${n[e]} ${a[r]} ${s}`;return q.jsx("button",{className:c,onClick:t,children:y})};export{I as B,k as G,R as L,z as P};
